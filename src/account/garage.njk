---
layout: layouts/base.njk
title: My Garage
description: Manage your garage vehicles, track restoration progress, and log maintenance history.
---

<main class="garage-page">
  <div class="container">
    <!-- Header -->
    <div class="garage-header">
      <div class="garage-header-content">
        <h1>My Garage</h1>
        <p class="garage-subtitle">Welcome back, <span id="user-display-name">Member</span></p>
      </div>
      <button type="button" class="btn btn-secondary" id="edit-profile-btn">Edit Profile</button>
    </div>

    <!-- Vehicle Grid -->
    <div class="garage-section">
      <div class="section-header">
        <h2>My Vehicles</h2>
        <div class="section-header-actions">
          <span class="vehicle-count"><span id="vehicle-count">0</span>/10 vehicles</span>
          <button type="button" class="btn btn-primary" id="add-vehicle-btn">+ Add Vehicle</button>
        </div>
      </div>
      <div class="vehicle-grid" id="vehicle-grid">
        <div class="empty-state" id="empty-vehicles">
          <p>No vehicles in your garage yet.</p>
          <p>Click "Add Vehicle" to get started tracking your cars.</p>
        </div>
      </div>
    </div>

    <!-- Selected Vehicle Detail -->
    <div class="garage-section vehicle-detail-section" id="vehicle-detail" style="display: none;">
      <div class="vehicle-detail-header">
        <div class="vehicle-detail-info">
          <h2 id="detail-vehicle-title">Vehicle Name</h2>
          <span class="platform-badge" id="detail-platform-badge">E30</span>
        </div>
        <div class="vehicle-detail-actions">
          <button type="button" class="btn btn-secondary" id="edit-vehicle-btn">Edit</button>
          <button type="button" class="btn btn-danger" id="delete-vehicle-btn">Delete</button>
        </div>
      </div>

      <!-- Vehicle Stats -->
      <div class="vehicle-stats-row">
        <div class="vehicle-stat-card">
          <span class="stat-label">Current Mileage</span>
          <span class="stat-value" id="detail-mileage">-</span>
        </div>
        <div class="vehicle-stat-card">
          <span class="stat-label">Year</span>
          <span class="stat-value" id="detail-year">-</span>
        </div>
        <div class="vehicle-stat-card">
          <span class="stat-label">Color</span>
          <span class="stat-value" id="detail-color">-</span>
        </div>
        <div class="vehicle-stat-card">
          <span class="stat-label">Restoration</span>
          <span class="stat-value" id="detail-restoration-progress">0%</span>
        </div>
      </div>

      <!-- Tabs -->
      <div class="vehicle-tabs">
        <button type="button" class="tab-btn active" data-tab="details">Details</button>
        <button type="button" class="tab-btn" data-tab="restoration">Restoration</button>
        <button type="button" class="tab-btn" data-tab="maintenance">Maintenance</button>
      </div>

      <!-- Details Tab -->
      <div class="tab-content active" id="tab-details">
        <div class="details-grid">
          <div class="detail-item">
            <label>VIN</label>
            <span id="detail-vin">-</span>
          </div>
          <div class="detail-item">
            <label>Purchase Date</label>
            <span id="detail-purchase-date">-</span>
          </div>
          <div class="detail-item">
            <label>Purchase Price</label>
            <span id="detail-purchase-price">-</span>
          </div>
          <div class="detail-item full-width">
            <label>Notes</label>
            <p id="detail-notes">-</p>
          </div>
        </div>
        <div class="mileage-update-section">
          <h4>Update Mileage</h4>
          <div class="mileage-update-form">
            <input type="number" id="update-mileage-input" placeholder="Enter current mileage">
            <button type="button" class="btn btn-primary" id="update-mileage-btn">Update</button>
          </div>
        </div>
      </div>

      <!-- Restoration Tab -->
      <div class="tab-content" id="tab-restoration">
        <div class="restoration-summary">
          <div class="restoration-header">
            <div class="restoration-progress-display">
              <div class="progress-bar large">
                <div class="progress-fill" id="restoration-progress-fill"></div>
              </div>
              <span class="progress-text" id="restoration-progress-text">0% Complete</span>
            </div>
          </div>
          <div class="restoration-stats-grid">
            <div class="restoration-stat">
              <span class="stat-number" id="restoration-completed">0</span>
              <span class="stat-label">Complete</span>
            </div>
            <div class="restoration-stat">
              <span class="stat-number" id="restoration-in-progress">0</span>
              <span class="stat-label">In Progress</span>
            </div>
            <div class="restoration-stat">
              <span class="stat-number" id="restoration-remaining">0</span>
              <span class="stat-label">Remaining</span>
            </div>
          </div>
          <div class="restoration-costs">
            <div class="cost-item">
              <span class="cost-label">Estimated Budget</span>
              <span class="cost-value" id="restoration-estimated">$0</span>
            </div>
            <div class="cost-item">
              <span class="cost-label">Actual Spent</span>
              <span class="cost-value" id="restoration-actual">$0</span>
            </div>
          </div>
          <div class="restoration-cta">
            <a href="#" class="btn btn-primary btn-lg" id="open-restoration-checklist">Open Full Checklist</a>
            <p class="restoration-cta-note">Track detailed progress, costs, and notes for each restoration item</p>
          </div>
        </div>
        <div class="restoration-category-summary" id="restoration-category-summary">
          <!-- Category progress bars loaded dynamically -->
        </div>
      </div>

      <!-- Maintenance Tab (Summary) -->
      <div class="tab-content" id="tab-maintenance">
        <div class="maintenance-summary">
          <div class="maintenance-status-cards">
            <div class="status-card overdue">
              <span class="status-number" id="maint-overdue-count">0</span>
              <span class="status-label">Overdue</span>
            </div>
            <div class="status-card due-soon">
              <span class="status-number" id="maint-due-soon-count">0</span>
              <span class="status-label">Due Soon</span>
            </div>
            <div class="status-card ok">
              <span class="status-number" id="maint-ok-count">0</span>
              <span class="status-label">Up to Date</span>
            </div>
          </div>
          <div class="maintenance-recent">
            <h4>Recent Services</h4>
            <div id="recent-services-list" class="recent-services-list">
              <p class="empty-state">No service records yet</p>
            </div>
          </div>
          <div class="maintenance-cta">
            <a href="#" class="btn btn-primary btn-lg" id="open-maintenance-tracker">Open Full Tracker</a>
            <p class="maintenance-cta-note">View schedules, log services, and track all maintenance</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoices Section -->
    <div class="garage-section invoices-section">
      <div class="section-header">
        <h2>Invoices</h2>
        <a href="/tools/invoice/" class="btn btn-primary">+ New Invoice</a>
      </div>
      <div class="invoices-stats" id="invoices-stats">
        <div class="invoice-stat-card">
          <span class="stat-value" id="invoices-total-count">0</span>
          <span class="stat-label">Total Invoices</span>
        </div>
        <div class="invoice-stat-card">
          <span class="stat-value" id="invoices-this-month">0</span>
          <span class="stat-label">This Month</span>
        </div>
        <div class="invoice-stat-card">
          <span class="stat-value" id="invoices-month-total">$0</span>
          <span class="stat-label">Month Total</span>
        </div>
      </div>
      <div class="recent-invoices" id="recent-invoices">
        <h4>Recent Invoices</h4>
        <div class="recent-invoices-list" id="recent-invoices-list">
          <p class="empty-state">No invoices yet</p>
        </div>
      </div>
    </div>

    <!-- Recent Forum Activity -->
    <div class="garage-section">
      <div class="section-header">
        <h2>Recent Forum Activity</h2>
        <a href="/forum/" class="btn btn-secondary">Browse Forums</a>
      </div>
      <div id="recent-threads" class="recent-threads-list">
        <p class="empty-state">Loading...</p>
      </div>
    </div>
  </div>
</main>

<!-- Add/Edit Vehicle Modal -->
<div class="modal-overlay" id="vehicle-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="vehicle-modal-title">Add Vehicle</h3>
      <button type="button" class="modal-close" id="close-vehicle-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="vehicle-nickname">Nickname</label>
        <input type="text" id="vehicle-nickname" placeholder="e.g., Daily Driver, Project Car">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="vehicle-platform">Platform *</label>
          <select id="vehicle-platform" required>
            <option value="">Select a platform...</option>
            <optgroup label="BMW">
              <option value="e28">E28 5-Series (1982-1988)</option>
              <option value="e30">E30 3-Series (1982-1994)</option>
              <option value="e34">E34 5-Series (1988-1996)</option>
              <option value="e36">E36 3-Series (1990-2000)</option>
              <option value="e39">E39 5-Series (1995-2004)</option>
              <option value="e46">E46 3-Series (1998-2006)</option>
              <option value="e90">E90 3-Series (2005-2013)</option>
            </optgroup>
            <optgroup label="Porsche">
              <option value="924">924 (1976-1988)</option>
              <option value="928">928 (1977-1995)</option>
              <option value="944">944 (1982-1991)</option>
              <option value="964">964 911 (1989-1994)</option>
              <option value="986">986 Boxster (1996-2004)</option>
              <option value="987">987 Boxster/Cayman (2005-2012)</option>
              <option value="991">991 911 (2011-2019)</option>
              <option value="993">993 911 (1994-1998)</option>
              <option value="996">996 911 (1997-2005)</option>
              <option value="997">997 911 (2004-2012)</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label for="vehicle-year">Year</label>
          <input type="number" id="vehicle-year" min="1976" max="2025" placeholder="e.g., 1988">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="vehicle-color">Color</label>
          <input type="text" id="vehicle-color" placeholder="e.g., Alpine White">
        </div>
        <div class="form-group">
          <label for="vehicle-mileage">Current Mileage</label>
          <input type="number" id="vehicle-mileage" min="0" placeholder="e.g., 125000">
        </div>
      </div>
      <div class="form-group">
        <label for="vehicle-vin">VIN</label>
        <input type="text" id="vehicle-vin" placeholder="e.g., WBAAB5401J8123456">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="vehicle-purchase-date">Purchase Date</label>
          <input type="date" id="vehicle-purchase-date">
        </div>
        <div class="form-group">
          <label for="vehicle-purchase-price">Purchase Price ($)</label>
          <input type="number" id="vehicle-purchase-price" min="0" step="0.01" placeholder="e.g., 15000">
        </div>
      </div>
      <div class="form-group">
        <label for="vehicle-notes">Notes</label>
        <textarea id="vehicle-notes" rows="3" placeholder="Any notes about this vehicle..."></textarea>
      </div>
      <input type="hidden" id="vehicle-edit-id">
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancel-vehicle-modal">Cancel</button>
      <button type="button" class="btn btn-primary" id="save-vehicle-btn">Save Vehicle</button>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal-overlay" id="profile-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Profile</h3>
      <button type="button" class="modal-close" id="close-profile-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="profile-display-name">Display Name</label>
        <input type="text" id="profile-display-name" maxlength="50">
      </div>
      <div class="form-group">
        <label for="profile-location">Location</label>
        <input type="text" id="profile-location" placeholder="City, State/Country" maxlength="100">
      </div>
      <div class="form-group">
        <label for="profile-bio">Bio</label>
        <textarea id="profile-bio" rows="3" maxlength="500" placeholder="Tell us about yourself..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancel-profile-modal">Cancel</button>
      <button type="button" class="btn btn-primary" id="save-profile-btn">Save Profile</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/js/supabase.js"></script>
<script src="/js/garage.js"></script>
<script src="/js/forum.js"></script>
<script>
// Restoration categories for summary display
const RESTORATION_CATEGORIES = {
  engine: 'Engine & Drivetrain',
  cooling: 'Cooling System',
  fuel: 'Fuel System',
  exhaust: 'Exhaust',
  suspension: 'Suspension & Steering',
  brakes: 'Brakes',
  electrical: 'Electrical',
  interior: 'Interior',
  body: 'Body & Paint',
  glass: 'Glass & Trim',
  seals: 'Weatherstripping & Seals'
};

(function() {
  'use strict';

  let currentUser = null;
  let currentProfile = null;
  let vehicles = [];
  let selectedVehicleId = null;
  let restorationData = {};
  let maintenanceSchedule = [];
  let serviceHistory = [];

  // Initialize
  async function init() {
    currentUser = await AuthUI.requireAuth();
    if (!currentUser) return;

    currentProfile = await Auth.getProfile(currentUser.id);
    document.getElementById('user-display-name').textContent =
      currentProfile?.display_name || currentProfile?.username || 'Member';

    await loadVehicles();
    await loadInvoices();
    await loadRecentThreads();
    bindEvents();
  }

  // Load invoices
  async function loadInvoices() {
    try {
      // Load stats
      const stats = await Garage.getInvoiceStats();
      document.getElementById('invoices-total-count').textContent = stats.totalInvoices;
      document.getElementById('invoices-this-month').textContent = stats.thisMonth;
      document.getElementById('invoices-month-total').textContent = '$' + stats.thisMonthTotal.toFixed(2);

      // Load recent invoices
      const invoices = await Garage.getInvoices({ limit: 5 });
      renderRecentInvoices(invoices);
    } catch (error) {
      console.error('Error loading invoices:', error);
    }
  }

  function renderRecentInvoices(invoices) {
    const container = document.getElementById('recent-invoices-list');

    if (invoices.length === 0) {
      container.innerHTML = '<p class="empty-state">No invoices yet. <a href="/tools/invoice/">Create your first invoice</a></p>';
      return;
    }

    container.innerHTML = invoices.map(invoice => `
      <a href="/tools/invoice/?edit=${invoice.id}" class="recent-invoice-item">
        <div class="invoice-item-info">
          <span class="invoice-item-number">${invoice.invoice_number}</span>
          <span class="invoice-item-customer">${invoice.customer_name || 'No customer'}</span>
        </div>
        <div class="invoice-item-meta">
          <span class="invoice-item-date">${Garage.formatDate(invoice.invoice_date)}</span>
          <span class="invoice-item-total">$${parseFloat(invoice.grand_total).toFixed(2)}</span>
        </div>
      </a>
    `).join('');
  }

  // Load vehicles
  async function loadVehicles() {
    try {
      vehicles = await Garage.getVehicles();
      renderVehicleGrid();
      document.getElementById('vehicle-count').textContent = vehicles.length;
    } catch (error) {
      console.error('Error loading vehicles:', error);
    }
  }

  // Render vehicle grid
  function renderVehicleGrid() {
    const grid = document.getElementById('vehicle-grid');
    const emptyState = document.getElementById('empty-vehicles');

    // Clear existing cards
    grid.querySelectorAll('.vehicle-card').forEach(card => card.remove());

    if (vehicles.length === 0) {
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';

    vehicles.forEach(vehicle => {
      const card = createVehicleCard(vehicle);
      grid.appendChild(card);
    });
  }

  // Create vehicle card
  function createVehicleCard(vehicle) {
    const card = document.createElement('div');
    card.className = 'vehicle-card' + (vehicle.id === selectedVehicleId ? ' selected' : '');
    card.dataset.id = vehicle.id;

    const platformInfo = Garage.getPlatformInfo(vehicle.platform);
    const displayName = vehicle.nickname ||
      (vehicle.year ? `${vehicle.year} ${platformInfo.name}` : platformInfo.name);

    card.innerHTML = `
      <div class="vehicle-card-image">
        ${vehicle.photo_url
          ? `<img src="${vehicle.photo_url}" alt="${displayName}">`
          : `<div class="vehicle-card-placeholder">${platformInfo.brand.charAt(0)}</div>`
        }
      </div>
      <div class="vehicle-card-content">
        <h3>${escapeHtml(displayName)}</h3>
        <span class="platform-badge">${platformInfo.name}</span>
        ${vehicle.mileage ? `<p class="vehicle-mileage">${vehicle.mileage.toLocaleString()} miles</p>` : ''}
      </div>
    `;

    card.addEventListener('click', () => selectVehicle(vehicle.id));
    return card;
  }

  // Select vehicle
  async function selectVehicle(vehicleId) {
    selectedVehicleId = vehicleId;

    // Update card selection
    document.querySelectorAll('.vehicle-card').forEach(card => {
      card.classList.toggle('selected', card.dataset.id == vehicleId);
    });

    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) return;

    // Show detail section
    document.getElementById('vehicle-detail').style.display = 'block';

    // Update header
    const platformInfo = Garage.getPlatformInfo(vehicle.platform);
    const displayName = vehicle.nickname ||
      (vehicle.year ? `${vehicle.year} ${platformInfo.name}` : platformInfo.name);
    document.getElementById('detail-vehicle-title').textContent = displayName;
    document.getElementById('detail-platform-badge').textContent = platformInfo.name;

    // Update stats
    document.getElementById('detail-mileage').textContent =
      vehicle.mileage ? vehicle.mileage.toLocaleString() + ' mi' : '-';
    document.getElementById('detail-year').textContent = vehicle.year || '-';
    document.getElementById('detail-color').textContent = vehicle.color || '-';

    // Update details tab
    document.getElementById('detail-vin').textContent = vehicle.vin || '-';
    document.getElementById('detail-purchase-date').textContent =
      vehicle.purchase_date ? Garage.formatDate(vehicle.purchase_date) : '-';
    document.getElementById('detail-purchase-price').textContent =
      vehicle.purchase_price ? '$' + parseFloat(vehicle.purchase_price).toLocaleString() : '-';
    document.getElementById('detail-notes').textContent = vehicle.notes || '-';

    // Load restoration, maintenance, and service data
    await Promise.all([
      loadRestorationData(vehicleId),
      loadMaintenanceData(vehicleId),
      loadServiceHistory(vehicleId)
    ]);

    // Scroll to detail
    document.getElementById('vehicle-detail').scrollIntoView({ behavior: 'smooth' });
  }

  // Load restoration data
  async function loadRestorationData(vehicleId) {
    try {
      restorationData = await Garage.getRestorationItems(vehicleId);
      updateRestorationSummary();

      // Update link to full checklist
      const checklistLink = document.getElementById('open-restoration-checklist');
      if (checklistLink) {
        checklistLink.href = `/tools/restoration-checklist/?vehicle=${vehicleId}`;
      }
    } catch (error) {
      console.error('Error loading restoration data:', error);
    }
  }

  // Update restoration summary display
  function updateRestorationSummary() {
    const items = Object.values(restorationData);

    // Count by status
    const completed = items.filter(i => i.status === 'complete').length;
    const inProgress = items.filter(i => i.status === 'in-progress').length;
    const remaining = items.filter(i => i.status === 'not-started').length;
    const total = items.length;

    // Calculate costs
    const estimatedTotal = items.reduce((sum, i) => sum + (i.estimatedCost || 0), 0);
    const actualTotal = items.reduce((sum, i) => sum + (i.actualCost || 0), 0);

    // Calculate percent (completed out of non-skipped items)
    const trackable = items.filter(i => i.status !== 'skipped').length;
    const percent = trackable > 0 ? Math.round((completed / trackable) * 100) : 0;

    // Update UI
    document.getElementById('restoration-progress-fill').style.width = percent + '%';
    document.getElementById('restoration-progress-text').textContent = percent + '% Complete';
    document.getElementById('restoration-completed').textContent = completed;
    document.getElementById('restoration-in-progress').textContent = inProgress;
    document.getElementById('restoration-remaining').textContent = remaining;
    document.getElementById('restoration-estimated').textContent = '$' + estimatedTotal.toLocaleString();
    document.getElementById('restoration-actual').textContent = '$' + actualTotal.toLocaleString();
    document.getElementById('detail-restoration-progress').textContent = percent + '%';

    // Render category summary
    renderCategorySummary();
  }

  // Render category-level progress
  function renderCategorySummary() {
    const container = document.getElementById('restoration-category-summary');
    if (!container) return;

    // Group items by category
    const categoryStats = {};
    Object.entries(restorationData).forEach(([itemId, item]) => {
      const cat = item.category || 'other';
      if (!categoryStats[cat]) {
        categoryStats[cat] = { total: 0, completed: 0 };
      }
      categoryStats[cat].total++;
      if (item.status === 'complete') {
        categoryStats[cat].completed++;
      }
    });

    // Only show if there's data
    if (Object.keys(categoryStats).length === 0) {
      container.innerHTML = '<p class="empty-state">No restoration items tracked yet. Open the full checklist to get started.</p>';
      return;
    }

    // Render progress bars for each category
    let html = '<h4>Progress by Category</h4><div class="category-progress-list">';

    Object.entries(categoryStats).forEach(([catId, stats]) => {
      const catName = RESTORATION_CATEGORIES[catId] || catId;
      const percent = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;

      html += `
        <div class="category-progress-item">
          <div class="category-progress-header">
            <span class="category-name">${catName}</span>
            <span class="category-count">${stats.completed}/${stats.total}</span>
          </div>
          <div class="progress-bar small">
            <div class="progress-fill" style="width: ${percent}%"></div>
          </div>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  // Load maintenance data for summary display
  async function loadMaintenanceData(vehicleId) {
    try {
      maintenanceSchedule = await Garage.getMaintenanceSchedule(vehicleId);
      const vehicle = vehicles.find(v => v.id === selectedVehicleId);

      // Calculate status counts using Garage helper
      const upcoming = Garage.getUpcomingMaintenance(maintenanceSchedule, vehicle?.mileage);

      let overdueCount = 0;
      let dueSoonCount = 0;
      let okCount = 0;

      upcoming.forEach(item => {
        if (item.status === 'overdue') overdueCount++;
        else if (item.status === 'due-soon') dueSoonCount++;
        else okCount++;
      });

      // Update status cards
      document.getElementById('maint-overdue-count').textContent = overdueCount;
      document.getElementById('maint-due-soon-count').textContent = dueSoonCount;
      document.getElementById('maint-ok-count').textContent = okCount;

      // Update link to full tracker
      const trackerLink = document.getElementById('open-maintenance-tracker');
      if (trackerLink) {
        trackerLink.href = `/tools/maintenance-tracker/?vehicle=${vehicleId}`;
      }
    } catch (error) {
      console.error('Error loading maintenance data:', error);
    }
  }

  // Load service history for summary display
  async function loadServiceHistory(vehicleId) {
    try {
      serviceHistory = await Garage.getServiceHistory(vehicleId);
      renderRecentServices();
    } catch (error) {
      console.error('Error loading service history:', error);
    }
  }

  // Render recent services (summary view)
  function renderRecentServices() {
    const container = document.getElementById('recent-services-list');

    if (serviceHistory.length === 0) {
      container.innerHTML = '<p class="empty-state">No service records yet</p>';
      return;
    }

    // Show last 5 services
    const recentServices = serviceHistory.slice(0, 5);

    container.innerHTML = recentServices.map(record => `
      <div class="recent-service-item">
        <div class="recent-service-info">
          <span class="recent-service-name">${escapeHtml(record.serviceName)}</span>
          <span class="recent-service-date">${Garage.formatDate(record.serviceDate)}</span>
        </div>
        ${record.mileage ? `<span class="recent-service-mileage">${record.mileage.toLocaleString()} mi</span>` : ''}
      </div>
    `).join('');
  }

  // Load recent threads
  async function loadRecentThreads() {
    try {
      const isLocal = window.location.hostname === 'localhost';
      const { data: threads, error } = await db
        .from('forum_threads')
        .select(`
          id,
          title,
          slug,
          created_at,
          reply_count,
          category:forum_categories(slug, name)
        `)
        .eq('author_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(5);

      const container = document.getElementById('recent-threads');

      if (error) throw error;

      if (!threads || threads.length === 0) {
        container.innerHTML = '<p class="empty-state">You haven\'t started any threads yet. <a href="/forum/new/">Start your first discussion</a></p>';
      } else {
        container.innerHTML = threads.map(thread => {
          const threadUrl = isLocal
            ? `/forum/thread/?slug=${thread.category.slug}&id=${thread.id}`
            : `/forum/${thread.category.slug}/${thread.id}/`;
          return `
            <div class="recent-thread">
              <a href="${threadUrl}" class="recent-thread-title">${escapeHtml(thread.title)}</a>
              <div class="recent-thread-meta">
                <span>${thread.category.name}</span>
                <span>${thread.reply_count} replies</span>
                <span>${Forum.timeAgo(thread.created_at)}</span>
              </div>
            </div>
          `;
        }).join('');
      }
    } catch (error) {
      console.error('Error loading threads:', error);
      document.getElementById('recent-threads').innerHTML = '<p class="empty-state">Unable to load recent threads</p>';
    }
  }

  // Bind events
  function bindEvents() {
    // Add vehicle button
    document.getElementById('add-vehicle-btn').addEventListener('click', () => openVehicleModal());

    // Vehicle modal
    document.getElementById('close-vehicle-modal').addEventListener('click', closeVehicleModal);
    document.getElementById('cancel-vehicle-modal').addEventListener('click', closeVehicleModal);
    document.getElementById('save-vehicle-btn').addEventListener('click', saveVehicle);
    document.getElementById('vehicle-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeVehicleModal();
    });

    // Edit/Delete vehicle
    document.getElementById('edit-vehicle-btn').addEventListener('click', () => {
      const vehicle = vehicles.find(v => v.id === selectedVehicleId);
      if (vehicle) openVehicleModal(vehicle);
    });
    document.getElementById('delete-vehicle-btn').addEventListener('click', deleteSelectedVehicle);

    // Update mileage
    document.getElementById('update-mileage-btn').addEventListener('click', updateMileage);

    // Profile modal
    document.getElementById('edit-profile-btn').addEventListener('click', openProfileModal);
    document.getElementById('close-profile-modal').addEventListener('click', closeProfileModal);
    document.getElementById('cancel-profile-modal').addEventListener('click', closeProfileModal);
    document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
    document.getElementById('profile-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeProfileModal();
    });

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // Restoration and maintenance links are set dynamically when vehicle is selected
  }

  // Vehicle Modal Functions
  function openVehicleModal(vehicle = null) {
    const modal = document.getElementById('vehicle-modal');
    const title = document.getElementById('vehicle-modal-title');

    if (vehicle) {
      title.textContent = 'Edit Vehicle';
      document.getElementById('vehicle-nickname').value = vehicle.nickname || '';
      document.getElementById('vehicle-platform').value = vehicle.platform;
      document.getElementById('vehicle-year').value = vehicle.year || '';
      document.getElementById('vehicle-color').value = vehicle.color || '';
      document.getElementById('vehicle-mileage').value = vehicle.mileage || '';
      document.getElementById('vehicle-vin').value = vehicle.vin || '';
      document.getElementById('vehicle-purchase-date').value = vehicle.purchase_date || '';
      document.getElementById('vehicle-purchase-price').value = vehicle.purchase_price || '';
      document.getElementById('vehicle-notes').value = vehicle.notes || '';
      document.getElementById('vehicle-edit-id').value = vehicle.id;
    } else {
      title.textContent = 'Add Vehicle';
      document.getElementById('vehicle-nickname').value = '';
      document.getElementById('vehicle-platform').value = '';
      document.getElementById('vehicle-year').value = '';
      document.getElementById('vehicle-color').value = '';
      document.getElementById('vehicle-mileage').value = '';
      document.getElementById('vehicle-vin').value = '';
      document.getElementById('vehicle-purchase-date').value = '';
      document.getElementById('vehicle-purchase-price').value = '';
      document.getElementById('vehicle-notes').value = '';
      document.getElementById('vehicle-edit-id').value = '';
    }

    modal.classList.add('active');
  }

  function closeVehicleModal() {
    document.getElementById('vehicle-modal').classList.remove('active');
  }

  async function saveVehicle() {
    const platform = document.getElementById('vehicle-platform').value;
    if (!platform) {
      alert('Please select a platform');
      return;
    }

    const vehicleData = {
      platform,
      nickname: document.getElementById('vehicle-nickname').value.trim() || null,
      year: document.getElementById('vehicle-year').value ? parseInt(document.getElementById('vehicle-year').value) : null,
      color: document.getElementById('vehicle-color').value.trim() || null,
      mileage: document.getElementById('vehicle-mileage').value ? parseInt(document.getElementById('vehicle-mileage').value) : null,
      vin: document.getElementById('vehicle-vin').value.trim() || null,
      purchaseDate: document.getElementById('vehicle-purchase-date').value || null,
      purchasePrice: document.getElementById('vehicle-purchase-price').value ? parseFloat(document.getElementById('vehicle-purchase-price').value) : null,
      notes: document.getElementById('vehicle-notes').value.trim() || null
    };

    const editId = document.getElementById('vehicle-edit-id').value;

    try {
      const saveBtn = document.getElementById('save-vehicle-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      if (editId) {
        await Garage.updateVehicle(editId, vehicleData);
      } else {
        const newVehicle = await Garage.addVehicle(vehicleData);
        // Initialize maintenance schedule with platform defaults
        await Garage.initializeMaintenanceSchedule(newVehicle.id, platform);
      }

      closeVehicleModal();
      await loadVehicles();

      if (editId) {
        await selectVehicle(parseInt(editId));
      }

      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Vehicle';
    } catch (error) {
      alert('Error saving vehicle: ' + error.message);
      document.getElementById('save-vehicle-btn').disabled = false;
      document.getElementById('save-vehicle-btn').textContent = 'Save Vehicle';
    }
  }

  async function deleteSelectedVehicle() {
    const vehicle = vehicles.find(v => v.id === selectedVehicleId);
    if (!vehicle) return;

    if (!confirm(`Delete "${vehicle.nickname || 'this vehicle'}"? All restoration progress and service history will be lost.`)) {
      return;
    }

    try {
      await Garage.deleteVehicle(selectedVehicleId);
      selectedVehicleId = null;
      document.getElementById('vehicle-detail').style.display = 'none';
      await loadVehicles();
    } catch (error) {
      alert('Error deleting vehicle: ' + error.message);
    }
  }

  async function updateMileage() {
    const input = document.getElementById('update-mileage-input');
    const newMileage = parseInt(input.value);
    if (!newMileage || newMileage < 0) {
      alert('Please enter a valid mileage');
      return;
    }

    try {
      await Garage.updateVehicle(selectedVehicleId, { mileage: newMileage });
      const vehicle = vehicles.find(v => v.id === selectedVehicleId);
      if (vehicle) vehicle.mileage = newMileage;
      document.getElementById('detail-mileage').textContent = newMileage.toLocaleString() + ' mi';
      input.value = '';
      renderVehicleGrid();
      renderUpcomingMaintenance();
    } catch (error) {
      alert('Error updating mileage: ' + error.message);
    }
  }

  // Profile Modal Functions
  function openProfileModal() {
    document.getElementById('profile-display-name').value = currentProfile?.display_name || '';
    document.getElementById('profile-location').value = currentProfile?.location || '';
    document.getElementById('profile-bio').value = currentProfile?.bio || '';
    document.getElementById('profile-modal').classList.add('active');
  }

  function closeProfileModal() {
    document.getElementById('profile-modal').classList.remove('active');
  }

  async function saveProfile() {
    try {
      const saveBtn = document.getElementById('save-profile-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      currentProfile = await Auth.updateProfile(currentUser.id, {
        display_name: document.getElementById('profile-display-name').value.trim() || null,
        location: document.getElementById('profile-location').value.trim() || null,
        bio: document.getElementById('profile-bio').value.trim() || null
      });

      document.getElementById('user-display-name').textContent =
        currentProfile?.display_name || currentProfile?.username || 'Member';

      closeProfileModal();
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Profile';
    } catch (error) {
      alert('Error saving profile: ' + error.message);
      document.getElementById('save-profile-btn').disabled = false;
      document.getElementById('save-profile-btn').textContent = 'Save Profile';
    }
  }

  // Helper: Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
