---
layout: layouts/base.njk
title: Set New Password
description: Set a new password for your ZRG Classics account.
---

<main class="auth-page">
  <div class="auth-container">
    <div class="auth-card">
      <h1>Set New Password</h1>
      <p class="auth-subtitle">Enter your new password below</p>

      <div id="loading-state" class="auth-loading">
        <p>Verifying reset link...</p>
      </div>

      <div id="error-state" class="auth-error" style="display: none;">
        <div class="alert alert-error">
          <h3>Invalid or Expired Link</h3>
          <p>This password reset link is invalid or has expired.</p>
        </div>
        <a href="/account/forgot-password/" class="btn btn-primary btn-block">Request New Link</a>
      </div>

      <form id="new-password-form" class="auth-form" style="display: none;">
        <div class="form-group">
          <label for="password">New Password</label>
          <input type="password" id="password" name="password" required autocomplete="new-password" minlength="8">
          <small class="form-hint">Minimum 8 characters</small>
        </div>

        <div class="form-group">
          <label for="confirm-password">Confirm New Password</label>
          <input type="password" id="confirm-password" name="confirm-password" required autocomplete="new-password">
        </div>

        <button type="submit" class="btn btn-primary btn-block">Update Password</button>
      </form>

      <div id="success-state" style="display: none;">
        <div class="alert alert-success">
          <h3>Password Updated</h3>
          <p>Your password has been successfully changed.</p>
        </div>
        <a href="/account/garage/" class="btn btn-primary btn-block">Go to My Garage</a>
      </div>
    </div>
  </div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/js/supabase.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const form = document.getElementById('new-password-form');
  const successState = document.getElementById('success-state');

  // Check if user arrived via password reset link
  // Supabase automatically handles the token exchange when the page loads
  const { data: { session }, error } = await db.auth.getSession();

  if (error || !session) {
    // No valid session - might be expired or invalid link
    // Wait a moment for Supabase to process the URL hash
    await new Promise(resolve => setTimeout(resolve, 1000));

    const { data: { session: retrySession } } = await db.auth.getSession();

    if (!retrySession) {
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
      return;
    }
  }

  // Valid session - show password form
  loadingState.style.display = 'none';
  form.style.display = 'block';

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const submitBtn = form.querySelector('button[type="submit"]');

    // Validate passwords match
    if (password !== confirmPassword) {
      AuthUI.showError(form, 'Passwords do not match');
      return;
    }

    // Validate password length
    if (password.length < 8) {
      AuthUI.showError(form, 'Password must be at least 8 characters');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    try {
      const { error } = await db.auth.updateUser({ password });

      if (error) throw error;

      form.style.display = 'none';
      successState.style.display = 'block';
    } catch (error) {
      AuthUI.showError(form, error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Password';
    }
  });
});
</script>
