---
layout: layouts/base.njk
title: My Account
description: Your ZRG Classics account - view your activity and manage your profile.
---

<main class="dashboard-page">
  <div class="container">
    <div class="dashboard-header">
      <h1>My Account</h1>
      <p class="dashboard-subtitle">Welcome back, <span id="user-name">Member</span></p>
    </div>

    <div class="dashboard-grid">
      <!-- Profile Card with Edit Form -->
      <div class="dashboard-card">
        <div class="card-header">
          <h2>Profile</h2>
        </div>
        <div class="profile-summary" id="profile-view">
          <div class="avatar-placeholder" id="user-avatar">
            <span id="avatar-initials">?</span>
          </div>
          <div class="profile-info">
            <p><strong>Username:</strong> <span id="profile-username">-</span></p>
            <p><strong>Display Name:</strong> <span id="profile-display-name">-</span></p>
            <p><strong>Location:</strong> <span id="profile-location">-</span></p>
            <p><strong>Member since:</strong> <span id="profile-joined">-</span></p>
            <p><strong>Posts:</strong> <span id="profile-posts">0</span></p>
          </div>
        </div>
        <button id="edit-profile-btn" class="btn btn-secondary btn-block" style="margin-top: 1rem;">Edit Profile</button>

        <!-- Edit Form (hidden by default) -->
        <form id="profile-form" class="profile-edit-form" style="display: none;">
          <div class="form-group">
            <label for="display-name">Display Name</label>
            <input type="text" id="display-name" name="display-name" maxlength="50">
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" name="location" placeholder="City, State/Country" maxlength="100">
          </div>
          <div class="form-group">
            <label for="bio">Bio</label>
            <textarea id="bio" name="bio" rows="3" maxlength="500" placeholder="Tell us about yourself..."></textarea>
          </div>
          <div class="form-group">
            <label for="vehicles">Your Vehicles</label>
            <input type="text" id="vehicles" name="vehicles" placeholder="e.g., 1988 E30 M3, 1995 993">
            <small class="form-hint">Comma-separated list</small>
          </div>
          <div class="form-actions">
            <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>

      <!-- Quick Links -->
      <div class="dashboard-card">
        <div class="card-header">
          <h2>Quick Links</h2>
        </div>
        <ul class="quick-links">
          <li><a href="/forum/">Browse Forums</a></li>
          <li><a href="/forum/new/">Start New Thread</a></li>
        </ul>
      </div>

      <!-- Recent Activity -->
      <div class="dashboard-card dashboard-card-wide">
        <div class="card-header">
          <h2>Your Recent Threads</h2>
        </div>
        <div id="recent-threads" class="recent-list">
          <p class="empty-state">Loading...</p>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/js/supabase.js"></script>
<script src="/js/forum.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Require authentication
  const user = await AuthUI.requireAuth();
  if (!user) return;

  const profileView = document.getElementById('profile-view');
  const profileForm = document.getElementById('profile-form');
  const editBtn = document.getElementById('edit-profile-btn');
  const cancelBtn = document.getElementById('cancel-edit-btn');

  let currentProfile = null;

  // Load profile
  currentProfile = await Auth.getProfile(user.id);

  if (currentProfile) {
    updateProfileView(currentProfile);
  }

  function updateProfileView(profile) {
    document.getElementById('user-name').textContent = profile.display_name || profile.username;
    document.getElementById('profile-username').textContent = profile.username;
    document.getElementById('profile-display-name').textContent = profile.display_name || '-';
    document.getElementById('profile-location').textContent = profile.location || '-';
    document.getElementById('profile-posts').textContent = profile.post_count || 0;
    document.getElementById('profile-joined').textContent = new Date(profile.created_at).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    const initials = (profile.display_name || profile.username).substring(0, 2).toUpperCase();
    document.getElementById('avatar-initials').textContent = initials;

    if (profile.avatar_url) {
      document.getElementById('user-avatar').innerHTML = `<img src="${profile.avatar_url}" alt="${profile.username}">`;
    }
  }

  // Edit button
  editBtn.addEventListener('click', () => {
    profileView.style.display = 'none';
    editBtn.style.display = 'none';
    profileForm.style.display = 'block';

    // Populate form
    document.getElementById('display-name').value = currentProfile.display_name || '';
    document.getElementById('location').value = currentProfile.location || '';
    document.getElementById('bio').value = currentProfile.bio || '';
    document.getElementById('vehicles').value = (currentProfile.vehicles || []).join(', ');
  });

  // Cancel button
  cancelBtn.addEventListener('click', () => {
    profileForm.style.display = 'none';
    profileView.style.display = 'flex';
    editBtn.style.display = 'block';
  });

  // Form submission
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = profileForm.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    const vehiclesInput = document.getElementById('vehicles').value;
    const vehicles = vehiclesInput ? vehiclesInput.split(',').map(v => v.trim()).filter(v => v) : [];

    try {
      currentProfile = await Auth.updateProfile(user.id, {
        display_name: document.getElementById('display-name').value.trim() || null,
        location: document.getElementById('location').value.trim() || null,
        bio: document.getElementById('bio').value.trim() || null,
        vehicles: vehicles
      });

      updateProfileView(currentProfile);
      profileForm.style.display = 'none';
      profileView.style.display = 'flex';
      editBtn.style.display = 'block';

      submitBtn.disabled = false;
      submitBtn.textContent = 'Save';
    } catch (error) {
      AuthUI.showError(profileForm, error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save';
    }
  });

  // Load recent threads
  try {
    const isLocal = window.location.hostname === 'localhost';
    const { data: threads, error } = await db
      .from('forum_threads')
      .select(`
        id,
        title,
        slug,
        created_at,
        reply_count,
        category:forum_categories(slug, name)
      `)
      .eq('author_id', user.id)
      .order('created_at', { ascending: false })
      .limit(5);

    const container = document.getElementById('recent-threads');

    if (error) throw error;

    if (!threads || threads.length === 0) {
      container.innerHTML = '<p class="empty-state">You haven\'t started any threads yet. <a href="/forum/new/">Start your first discussion</a></p>';
    } else {
      container.innerHTML = threads.map(thread => {
        const threadUrl = isLocal
          ? `/forum/thread/?slug=${thread.category.slug}&id=${thread.id}`
          : `/forum/${thread.category.slug}/${thread.id}/`;
        return `
        <div class="recent-item">
          <a href="${threadUrl}" class="recent-title">${Forum.sanitizeHtml(thread.title)}</a>
          <div class="recent-meta">
            <span>${thread.category.name}</span>
            <span>${thread.reply_count} replies</span>
            <span>${Forum.timeAgo(thread.created_at)}</span>
          </div>
        </div>
      `}).join('');
    }
  } catch (error) {
    console.error('Error loading threads:', error);
    document.getElementById('recent-threads').innerHTML = '<p class="empty-state">Unable to load recent threads</p>';
  }
});
</script>
