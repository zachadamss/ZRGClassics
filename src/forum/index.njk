---
layout: layouts/base.njk
title: Forums
description: Join the ZRG Classics community forums. Discuss classic BMW and Porsche maintenance, modifications, and share your enthusiasm with fellow enthusiasts.
---

<main class="forum-page">
  <div class="container">
    <div class="forum-header">
      <h1>Community Forums</h1>
      <p class="forum-subtitle">Connect with fellow enthusiasts</p>
      <div class="forum-actions">
        <a href="/forum/new/" class="btn btn-primary" id="new-thread-btn">Start New Thread</a>
      </div>
    </div>

    <div class="forum-search">
      <input type="text" id="forum-search" placeholder="Search forums..." autocomplete="off">
    </div>

    <div id="forum-categories" class="forum-categories">
      <div class="loading">Loading forums...</div>
    </div>
  </div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/js/supabase.js"></script>
<script src="/js/forum.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('forum-categories');
  const newThreadBtn = document.getElementById('new-thread-btn');
  const searchInput = document.getElementById('forum-search');

  // Check if user is logged in for new thread button
  const user = await Auth.getUser();
  if (!user) {
    newThreadBtn.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = '/account/login/?return=/forum/new/';
    });
  }

  try {
    const grouped = await Forum.getCategoriesGrouped();

    let html = '';

    // General Discussion
    if (grouped.general.length > 0) {
      html += `
        <div class="category-group">
          <h2 class="category-group-title">General</h2>
          <div class="category-list">
            ${grouped.general.map(cat => renderCategory(cat)).join('')}
          </div>
        </div>
      `;
    }

    // BMW Forums
    if (grouped.bmw.length > 0) {
      html += `
        <div class="category-group">
          <h2 class="category-group-title">BMW Forums</h2>
          <div class="category-list">
            ${grouped.bmw.map(cat => renderCategory(cat)).join('')}
          </div>
        </div>
      `;
    }

    // Porsche Forums
    if (grouped.porsche.length > 0) {
      html += `
        <div class="category-group">
          <h2 class="category-group-title">Porsche Forums</h2>
          <div class="category-list">
            ${grouped.porsche.map(cat => renderCategory(cat)).join('')}
          </div>
        </div>
      `;
    }

    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading categories:', error);
    container.innerHTML = '<p class="error">Unable to load forums. Please try again later.</p>';
  }

  // Search functionality
  let searchTimeout;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const query = searchInput.value.trim();
      if (query.length >= 2) {
        window.location.href = `/forum/search/?q=${encodeURIComponent(query)}`;
      }
    }, 500);
  });

  function renderCategory(cat) {
    // Use query param locally, clean URL on Vercel
    const isLocal = window.location.hostname === 'localhost';
    const categoryUrl = isLocal ? `/forum/category/?slug=${cat.slug}` : `/forum/${cat.slug}/`;
    return `
      <a href="${categoryUrl}" class="category-card">
        <div class="category-info">
          <h3 class="category-name">${cat.name}</h3>
          <p class="category-description">${cat.description || ''}</p>
        </div>
        <div class="category-stats">
          <span class="stat">${cat.thread_count || 0} threads</span>
          <span class="stat">${cat.post_count || 0} posts</span>
        </div>
      </a>
    `;
  }
});
</script>
